'use strict';

var _ = require('lodash');
var util = require('util');

var parser = require('./parser');

var arraySort = function arraySort(a, b) {
  if (a > b) return 1;
  if (a < b) return -1;
  return 0;
};

var normalizeTypeDef = function normalizeTypeDef(typeDef) {
  return typeDef.replace(/[\s]/g, '').replace(/varchar/g, 'text').replace(/frozen/ig, 'frozen');
};

var normalizer = {
  normalize_replication_option(replicationOptions) {
    var normalizedReplicationOptions = replicationOptions;
    Object.keys(normalizedReplicationOptions).forEach(function (key) {
      if (key === 'class') {
        normalizedReplicationOptions[key] = normalizedReplicationOptions[key].replace('org.apache.cassandra.locator.', '');
        return;
      }
      normalizedReplicationOptions[key] = parseInt(normalizedReplicationOptions[key], 10);
    });
    return normalizedReplicationOptions;
  },

  normalize_user_defined_type(fieldType) {
    var normalizedFieldType = normalizeTypeDef(fieldType);
    if (normalizedFieldType.includes('<') && !normalizedFieldType.startsWith('frozen<')) {
      normalizedFieldType = util.format('frozen<%s>', normalizedFieldType);
    }
    return normalizedFieldType;
  },

  normalize_primary_key(outputSchema) {
    if (outputSchema.key && typeof outputSchema.key[0] === 'string') {
      outputSchema.key[0] = [outputSchema.key[0]];
    }

    if (outputSchema.key && outputSchema.key.length) {
      for (var i = 1; i < outputSchema.key.length; i++) {
        if (!outputSchema.clustering_order) outputSchema.clustering_order = {};
        if (!outputSchema.clustering_order[outputSchema.key[i]]) {
          outputSchema.clustering_order[outputSchema.key[i]] = 'ASC';
        }

        // eslint-disable-next-line max-len
        outputSchema.clustering_order[outputSchema.key[i]] = outputSchema.clustering_order[outputSchema.key[i]].toUpperCase();
      }
    }
  },

  normalize_fields(modelSchema, outputSchema) {
    Object.keys(outputSchema.fields).forEach(function (fieldName) {
      if (typeof outputSchema.fields[fieldName] === 'string') {
        outputSchema.fields[fieldName] = { type: outputSchema.fields[fieldName] };
      }

      if (fieldName === 'solr_query' || outputSchema.fields[fieldName].virtual) {
        delete outputSchema.fields[fieldName];
        return;
      }

      if (outputSchema.fields[fieldName].typeDef) {
        outputSchema.fields[fieldName] = {
          type: outputSchema.fields[fieldName].type,
          typeDef: outputSchema.fields[fieldName].typeDef
        };
      } else {
        outputSchema.fields[fieldName] = { type: outputSchema.fields[fieldName].type };
      }

      if (outputSchema.fields[fieldName].type === 'varchar') {
        outputSchema.fields[fieldName].type = 'text';
      }

      if (['map', 'list', 'set', 'frozen'].includes(outputSchema.fields[fieldName].type)) {
        if (modelSchema.typeMaps && modelSchema.typeMaps[fieldName]) {
          outputSchema.fields[fieldName].typeDef = modelSchema.typeMaps[fieldName];
        } else {
          outputSchema.fields[fieldName].typeDef = normalizeTypeDef(outputSchema.fields[fieldName].typeDef);
        }
      }

      if (modelSchema.staticMaps && modelSchema.staticMaps[fieldName] === true) {
        outputSchema.fields[fieldName].static = true;
      } else if (modelSchema.fields[fieldName].static) {
        outputSchema.fields[fieldName].static = true;
      }
    });
  },

  normalize_materialized_views(outputSchema) {
    if (!outputSchema.materialized_views) {
      outputSchema.materialized_views = {};
    }

    Object.keys(outputSchema.materialized_views).forEach(function (materializedViewName) {
      var outputMView = outputSchema.materialized_views[materializedViewName];
      // make parition key an array
      if (outputMView.key && typeof outputMView.key[0] === 'string') {
        outputMView.key[0] = [outputMView.key[0]];
      }

      // add clustering_order for all clustering keys
      if (outputMView.key && outputMView.key.length) {
        for (var i = 1; i < outputMView.key.length; i++) {
          if (!outputMView.clustering_order) {
            outputMView.clustering_order = {};
          }
          if (!outputMView.clustering_order[outputMView.key[i]]) {
            outputMView.clustering_order[outputMView.key[i]] = 'ASC';
          }
          // eslint-disable-next-line max-len
          outputMView.clustering_order[outputMView.key[i]] = outputMView.clustering_order[outputMView.key[i]].toUpperCase();
        }
      }

      // add all non existent primary key items to select and sort them
      for (var pkeyIndex = 0; pkeyIndex < outputMView.key.length; pkeyIndex++) {
        if (pkeyIndex === 0) {
          for (var partitionIndex = 0; partitionIndex < outputMView.key[pkeyIndex].length; partitionIndex++) {
            if (!outputMView.select.includes(outputMView.key[pkeyIndex][partitionIndex])) {
              outputMView.select.push(outputMView.key[pkeyIndex][partitionIndex]);
            }
          }
        } else if (!outputMView.select.includes(outputMView.key[pkeyIndex])) {
          outputMView.select.push(outputMView.key[pkeyIndex]);
        }
      }

      // check if select has * and then add all fields to select
      if (outputMView.select[0] === '*') {
        outputMView.select = Object.keys(outputSchema.fields);
      }

      outputMView.select.sort(arraySort);

      if (!outputMView.where_clause) {
        outputMView.where_clause = parser.get_mview_where_clause(outputSchema, outputMView);
      }
      if (_.isPlainObject(outputMView.filters)) {
        delete outputMView.filters;
      }
    });
  },

  normalize_indexes(outputSchema) {
    if (!outputSchema.indexes) {
      outputSchema.indexes = [];
    }
    for (var i = 0; i < outputSchema.indexes.length; i++) {
      var indexNameList = outputSchema.indexes[i].replace(/["\s]/g, '').split(/[()]/g);
      if (indexNameList.length > 1) {
        indexNameList[0] = indexNameList[0].toLowerCase();
        if (indexNameList[0] === 'values') outputSchema.indexes[i] = indexNameList[1];else outputSchema.indexes[i] = util.format('%s(%s)', indexNameList[0], indexNameList[1]);
      } else {
        outputSchema.indexes[i] = indexNameList[0];
      }
    }
    outputSchema.indexes.sort(arraySort);
  },

  normalize_custom_indexes(outputSchema) {
    if (outputSchema.custom_index) {
      outputSchema.custom_indexes = [outputSchema.custom_index];
      delete outputSchema.custom_index;
    }

    if (outputSchema.custom_indexes) {
      var customArraySort = function customArraySort(a, b) {
        if (a.on > b.on) return 1;
        if (a.on < b.on) return -1;

        if (a.using > b.using) return 1;
        if (a.using < b.using) return -1;

        if (a.options > b.options) return 1;
        if (a.options < b.options) return -1;

        return 0;
      };

      outputSchema.custom_indexes.sort(customArraySort);
    } else {
      outputSchema.custom_indexes = [];
    }

    outputSchema.custom_indexes = _.remove(outputSchema.custom_indexes, function (cindex) {
      return cindex.on !== 'solr_query';
    });
  },

  normalize_model_schema(modelSchema) {
    var outputSchema = _.cloneDeep(modelSchema, true);
    var normalizableSchemaProperties = ['fields', 'key', 'clustering_order', 'materialized_views', 'indexes', 'custom_index', 'custom_indexes'];

    Object.keys(outputSchema).forEach(function (schemaProperty) {
      if (!normalizableSchemaProperties.includes(schemaProperty)) {
        delete outputSchema[schemaProperty];
      }
    });

    this.normalize_fields(modelSchema, outputSchema);
    this.normalize_primary_key(outputSchema);
    this.normalize_materialized_views(outputSchema);
    this.normalize_indexes(outputSchema);
    this.normalize_custom_indexes(outputSchema);

    return outputSchema;
  },

  remove_dependent_views_from_normalized_schema(normalizedDBSchema, dbSchema, fieldName) {
    var dependentViews = [];
    Object.keys(normalizedDBSchema.materialized_views).forEach(function (dbViewName) {
      if (normalizedDBSchema.materialized_views[dbViewName].select.includes(fieldName)) {
        dependentViews.push(dbViewName);
      } else if (normalizedDBSchema.materialized_views[dbViewName].select[0] === '*') {
        dependentViews.push(dbViewName);
      } else if (normalizedDBSchema.materialized_views[dbViewName].key.includes(fieldName)) {
        dependentViews.push(dbViewName);
      } else if (_.isArray(normalizedDBSchema.materialized_views[dbViewName].key[0]) && normalizedDBSchema.materialized_views[dbViewName].key[0].includes(fieldName)) {
        dependentViews.push(dbViewName);
      }
    });
    dependentViews.forEach(function (viewName) {
      normalizedDBSchema.materialized_views[viewName] = {};
    });
  }
};

module.exports = normalizer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9ub3JtYWxpemVyLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwidXRpbCIsInBhcnNlciIsImFycmF5U29ydCIsImEiLCJiIiwibm9ybWFsaXplVHlwZURlZiIsInR5cGVEZWYiLCJyZXBsYWNlIiwibm9ybWFsaXplciIsIm5vcm1hbGl6ZV9yZXBsaWNhdGlvbl9vcHRpb24iLCJyZXBsaWNhdGlvbk9wdGlvbnMiLCJub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJwYXJzZUludCIsIm5vcm1hbGl6ZV91c2VyX2RlZmluZWRfdHlwZSIsImZpZWxkVHlwZSIsIm5vcm1hbGl6ZWRGaWVsZFR5cGUiLCJpbmNsdWRlcyIsInN0YXJ0c1dpdGgiLCJmb3JtYXQiLCJub3JtYWxpemVfcHJpbWFyeV9rZXkiLCJvdXRwdXRTY2hlbWEiLCJsZW5ndGgiLCJpIiwiY2x1c3RlcmluZ19vcmRlciIsInRvVXBwZXJDYXNlIiwibm9ybWFsaXplX2ZpZWxkcyIsIm1vZGVsU2NoZW1hIiwiZmllbGRzIiwiZmllbGROYW1lIiwidHlwZSIsInZpcnR1YWwiLCJ0eXBlTWFwcyIsInN0YXRpY01hcHMiLCJzdGF0aWMiLCJub3JtYWxpemVfbWF0ZXJpYWxpemVkX3ZpZXdzIiwibWF0ZXJpYWxpemVkX3ZpZXdzIiwibWF0ZXJpYWxpemVkVmlld05hbWUiLCJvdXRwdXRNVmlldyIsInBrZXlJbmRleCIsInBhcnRpdGlvbkluZGV4Iiwic2VsZWN0IiwicHVzaCIsInNvcnQiLCJ3aGVyZV9jbGF1c2UiLCJnZXRfbXZpZXdfd2hlcmVfY2xhdXNlIiwiaXNQbGFpbk9iamVjdCIsImZpbHRlcnMiLCJub3JtYWxpemVfaW5kZXhlcyIsImluZGV4ZXMiLCJpbmRleE5hbWVMaXN0Iiwic3BsaXQiLCJ0b0xvd2VyQ2FzZSIsIm5vcm1hbGl6ZV9jdXN0b21faW5kZXhlcyIsImN1c3RvbV9pbmRleCIsImN1c3RvbV9pbmRleGVzIiwiY3VzdG9tQXJyYXlTb3J0Iiwib24iLCJ1c2luZyIsIm9wdGlvbnMiLCJyZW1vdmUiLCJjaW5kZXgiLCJub3JtYWxpemVfbW9kZWxfc2NoZW1hIiwiY2xvbmVEZWVwIiwibm9ybWFsaXphYmxlU2NoZW1hUHJvcGVydGllcyIsInNjaGVtYVByb3BlcnR5IiwicmVtb3ZlX2RlcGVuZGVudF92aWV3c19mcm9tX25vcm1hbGl6ZWRfc2NoZW1hIiwibm9ybWFsaXplZERCU2NoZW1hIiwiZGJTY2hlbWEiLCJkZXBlbmRlbnRWaWV3cyIsImRiVmlld05hbWUiLCJpc0FycmF5Iiwidmlld05hbWUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLElBQUlDLFFBQVEsUUFBUixDQUFWO0FBQ0EsSUFBTUMsT0FBT0QsUUFBUSxNQUFSLENBQWI7O0FBRUEsSUFBTUUsU0FBU0YsUUFBUSxVQUFSLENBQWY7O0FBRUEsSUFBTUcsWUFBWSxTQUFaQSxTQUFZLENBQUNDLENBQUQsRUFBSUMsQ0FBSixFQUFVO0FBQzFCLE1BQUlELElBQUlDLENBQVIsRUFBVyxPQUFPLENBQVA7QUFDWCxNQUFJRCxJQUFJQyxDQUFSLEVBQVcsT0FBTyxDQUFDLENBQVI7QUFDWCxTQUFPLENBQVA7QUFDRCxDQUpEOztBQU1BLElBQU1DLG1CQUFtQixTQUFuQkEsZ0JBQW1CLENBQUNDLE9BQUQ7QUFBQSxTQUFhQSxRQUFRQyxPQUFSLENBQWdCLE9BQWhCLEVBQXlCLEVBQXpCLEVBQTZCQSxPQUE3QixDQUFxQyxVQUFyQyxFQUFpRCxNQUFqRCxFQUF5REEsT0FBekQsQ0FBaUUsVUFBakUsRUFBNkUsUUFBN0UsQ0FBYjtBQUFBLENBQXpCOztBQUVBLElBQU1DLGFBQWE7QUFDakJDLCtCQUE2QkMsa0JBQTdCLEVBQWlEO0FBQy9DLFFBQU1DLCtCQUErQkQsa0JBQXJDO0FBQ0FFLFdBQU9DLElBQVAsQ0FBWUYsNEJBQVosRUFBMENHLE9BQTFDLENBQWtELFVBQUNDLEdBQUQsRUFBUztBQUN6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Q0FBeUQsQ0FBekQsTUFBZ0UsR0FBcEUsRUFBeUU7QUFDOUU0Qix1QkFBZTNCLElBQWYsQ0FBb0I0QixVQUFwQjtBQUNELE9BRk0sTUFFQSxJQUFJSCxtQkFBbUIvQixrQkFBbkIsQ0FBc0NrQyxVQUF0QyxFQUFrRDFELEdBQWxELENBQXNESyxRQUF0RCxDQUErRFksU0FBL0QsQ0FBSixFQUErRTtBQUNwRndDLHVCQUFlM0IsSUFBZixDQUFvQjRCLFVBQXBCO0FBQ0QsT0FGTSxNQUVBLElBQUkzRSxFQUFFNEUsT0FBRixDQUFVSixtQkFBbUIvQixrQkFBbkIsQ0FBc0NrQyxVQUF0QyxFQUFrRDFELEdBQWxELENBQXNELENBQXRELENBQVYsS0FDSXVELG1CQUFtQi9CLGtCQUFuQixDQUFzQ2tDLFVBQXRDLEVBQWtEMUQsR0FBbEQsQ0FBc0QsQ0FBdEQsRUFBeURLLFFBQXpELENBQWtFWSxTQUFsRSxDQURSLEVBQ3NGO0FBQzNGd0MsdUJBQWUzQixJQUFmLENBQW9CNEIsVUFBcEI7QUFDRDtBQUNGLEtBWEQ7QUFZQUQsbUJBQWUxRCxPQUFmLENBQXVCLFVBQUM2RCxRQUFELEVBQWM7QUFDbkNMLHlCQUFtQi9CLGtCQUFuQixDQUFzQ29DLFFBQXRDLElBQWtELEVBQWxEO0FBQ0QsS0FGRDtBQUdEO0FBek5nQixDQUFuQjs7QUE0TkFDLE9BQU9DLE9BQVAsR0FBaUJyRSxVQUFqQiIsImZpbGUiOiJub3JtYWxpemVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcblxuY29uc3QgcGFyc2VyID0gcmVxdWlyZSgnLi9wYXJzZXInKTtcblxuY29uc3QgYXJyYXlTb3J0ID0gKGEsIGIpID0+IHtcbiAgaWYgKGEgPiBiKSByZXR1cm4gMTtcbiAgaWYgKGEgPCBiKSByZXR1cm4gLTE7XG4gIHJldHVybiAwO1xufTtcblxuY29uc3Qgbm9ybWFsaXplVHlwZURlZiA9ICh0eXBlRGVmKSA9PiB0eXBlRGVmLnJlcGxhY2UoL1tcXHNdL2csICcnKS5yZXBsYWNlKC92YXJjaGFyL2csICd0ZXh0JykucmVwbGFjZSgvZnJvemVuL2lnLCAnZnJvemVuJyk7XG5cbmNvbnN0IG5vcm1hbGl6ZXIgPSB7XG4gIG5vcm1hbGl6ZV9yZXBsaWNhdGlvbl9vcHRpb24ocmVwbGljYXRpb25PcHRpb25zKSB7XG4gICAgY29uc3Qgbm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9ucyA9IHJlcGxpY2F0aW9uT3B0aW9ucztcbiAgICBPYmplY3Qua2V5cyhub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGlmIChrZXkgPT09ICdjbGFzcycpIHtcbiAgICAgICAgbm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9uc1trZXldID0gbm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9uc1trZXldLnJlcGxhY2UoJ29yZy5hcGFjaGUuY2Fzc2FuZHJhLmxvY2F0b3IuJywgJycpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zW2tleV0gPSBwYXJzZUludChub3JtYWxpemVkUmVwbGljYXRpb25PcHRpb25zW2tleV0sIDEwKTtcbiAgICB9KTtcbiAgICByZXR1cm4gbm9ybWFsaXplZFJlcGxpY2F0aW9uT3B0aW9ucztcbiAgfSxcblxuICBub3JtYWxpemVfdXNlcl9kZWZpbmVkX3R5cGUoZmllbGRUeXBlKSB7XG4gICAgbGV0IG5vcm1hbGl6ZWRGaWVsZFR5cGUgPSBub3JtYWxpemVUeXBlRGVmKGZpZWxkVHlwZSk7XG4gICAgaWYgKG5vcm1hbGl6ZWRGaWVsZFR5cGUuaW5jbHVkZXMoJzwnKSAmJiAhbm9ybWFsaXplZEZpZWxkVHlwZS5zdGFydHNXaXRoKCdmcm96ZW48JykpIHtcbiAgICAgIG5vcm1hbGl6ZWRGaWVsZFR5cGUgPSB1dGlsLmZvcm1hdCgnZnJvemVuPCVzPicsIG5vcm1hbGl6ZWRGaWVsZFR5cGUpO1xuICAgIH1cbiAgICByZXR1cm4gbm9ybWFsaXplZEZpZWxkVHlwZTtcbiAgfSxcblxuICBub3JtYWxpemVfcHJpbWFyeV9rZXkob3V0cHV0U2NoZW1hKSB7XG4gICAgaWYgKG91dHB1dFNjaGVtYS5rZXkgJiYgdHlwZW9mIG91dHB1dFNjaGVtYS5rZXlbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICBvdXRwdXRTY2hlbWEua2V5WzBdID0gW291dHB1dFNjaGVtYS5rZXlbMF1dO1xuICAgIH1cblxuICAgIGlmIChvdXRwdXRTY2hlbWEua2V5ICYmIG91dHB1dFNjaGVtYS5rZXkubGVuZ3RoKSB7XG4gICAgICBmb3IgKGxldCBpID0gMTsgaSA8IG91dHB1dFNjaGVtYS5rZXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKCFvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcikgb3V0cHV0U2NoZW1hLmNsdXN0ZXJpbmdfb3JkZXIgPSB7fTtcbiAgICAgICAgaWYgKCFvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcltvdXRwdXRTY2hlbWEua2V5W2ldXSkge1xuICAgICAgICAgIG91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyW291dHB1dFNjaGVtYS5rZXlbaV1dID0gJ0FTQyc7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgICAgICBvdXRwdXRTY2hlbWEuY2x1c3RlcmluZ19vcmRlcltvdXRwdXRTY2hlbWEua2V5W2ldXSA9IG91dHB1dFNjaGVtYS5jbHVzdGVyaW5nX29yZGVyW291dHB1dFNjaGVtYS5rZXlbaV1dLnRvVXBwZXJDYXNlKCk7XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIG5vcm1hbGl6ZV9maWVsZHMobW9kZWxTY2hlbWEsIG91dHB1dFNjaGVtYSkge1xuICAgIE9iamVjdC5rZXlzKG91dHB1dFNjaGVtYS5maWVsZHMpLmZvckVhY2goKGZpZWxkTmFtZSkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiAob3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdID0geyB0eXBlOiBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0gfTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZpZWxkTmFtZSA9PT0gJ3NvbHJfcXVlcnknIHx8IG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS52aXJ0dWFsKSB7XG4gICAgICAgIGRlbGV0ZSBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlRGVmKSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSA9IHtcbiAgICAgICAgICB0eXBlOiBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZSxcbiAgICAgICAgICB0eXBlRGVmOiBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZURlZixcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSA9IHsgdHlwZTogb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGUgfTtcbiAgICAgIH1cblxuICAgICAgaWYgKG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlID09PSAndmFyY2hhcicpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGUgPSAndGV4dCc7XG4gICAgICB9XG5cbiAgICAgIGlmIChbJ21hcCcsICdsaXN0JywgJ3NldCcsICdmcm96ZW4nXS5pbmNsdWRlcyhvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZSkpIHtcbiAgICAgICAgaWYgKG1vZGVsU2NoZW1hLnR5cGVNYXBzICYmIG1vZGVsU2NoZW1hLnR5cGVNYXBzW2ZpZWxkTmFtZV0pIHtcbiAgICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0udHlwZURlZiA9IG1vZGVsU2NoZW1hLnR5cGVNYXBzW2ZpZWxkTmFtZV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnR5cGVEZWYgPSBub3JtYWxpemVUeXBlRGVmKG91dHB1dFNjaGVtYS5maWVsZHNbZmllbGROYW1lXS50eXBlRGVmKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAobW9kZWxTY2hlbWEuc3RhdGljTWFwcyAmJiBtb2RlbFNjaGVtYS5zdGF0aWNNYXBzW2ZpZWxkTmFtZV0gPT09IHRydWUpIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnN0YXRpYyA9IHRydWU7XG4gICAgICB9IGVsc2UgaWYgKG1vZGVsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdLnN0YXRpYykge1xuICAgICAgICBvdXRwdXRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0uc3RhdGljID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcblxuICBub3JtYWxpemVfbWF0ZXJpYWxpemVkX3ZpZXdzKG91dHB1dFNjaGVtYSkge1xuICAgIGlmICghb3V0cHV0U2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cykge1xuICAgICAgb3V0cHV0U2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cyA9IHt9O1xuICAgIH1cblxuICAgIE9iamVjdC5rZXlzKG91dHB1dFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3MpLmZvckVhY2goKG1hdGVyaWFsaXplZFZpZXdOYW1lKSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXRNVmlldyA9IG91dHB1dFNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbbWF0ZXJpYWxpemVkVmlld05hbWVdO1xuICAgICAgLy8gbWFrZSBwYXJpdGlvbiBrZXkgYW4gYXJyYXlcbiAgICAgIGlmIChvdXRwdXRNVmlldy5rZXkgJiYgdHlwZW9mIG91dHB1dE1WaWV3LmtleVswXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb3V0cHV0TVZpZXcua2V5WzBdID0gW291dHB1dE1WaWV3LmtleVswXV07XG4gICAgICB9XG5cbiAgICAgIC8vIGFkZCBjbHVzdGVyaW5nX29yZGVyIGZvciBhbGwgY2x1c3RlcmluZyBrZXlzXG4gICAgICBpZiAob3V0cHV0TVZpZXcua2V5ICYmIG91dHB1dE1WaWV3LmtleS5sZW5ndGgpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBvdXRwdXRNVmlldy5rZXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAoIW91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXIpIHtcbiAgICAgICAgICAgIG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXIgPSB7fTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFvdXRwdXRNVmlldy5jbHVzdGVyaW5nX29yZGVyW291dHB1dE1WaWV3LmtleVtpXV0pIHtcbiAgICAgICAgICAgIG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0TVZpZXcua2V5W2ldXSA9ICdBU0MnO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgICAgICAgIG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0TVZpZXcua2V5W2ldXSA9IG91dHB1dE1WaWV3LmNsdXN0ZXJpbmdfb3JkZXJbb3V0cHV0TVZpZXcua2V5W2ldXS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIGFkZCBhbGwgbm9uIGV4aXN0ZW50IHByaW1hcnkga2V5IGl0ZW1zIHRvIHNlbGVjdCBhbmQgc29ydCB0aGVtXG4gICAgICBmb3IgKGxldCBwa2V5SW5kZXggPSAwOyBwa2V5SW5kZXggPCBvdXRwdXRNVmlldy5rZXkubGVuZ3RoOyBwa2V5SW5kZXgrKykge1xuICAgICAgICBpZiAocGtleUluZGV4ID09PSAwKSB7XG4gICAgICAgICAgZm9yIChsZXQgcGFydGl0aW9uSW5kZXggPSAwOyBwYXJ0aXRpb25JbmRleCA8IG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdLmxlbmd0aDsgcGFydGl0aW9uSW5kZXgrKykge1xuICAgICAgICAgICAgaWYgKCFvdXRwdXRNVmlldy5zZWxlY3QuaW5jbHVkZXMob3V0cHV0TVZpZXcua2V5W3BrZXlJbmRleF1bcGFydGl0aW9uSW5kZXhdKSkge1xuICAgICAgICAgICAgICBvdXRwdXRNVmlldy5zZWxlY3QucHVzaChvdXRwdXRNVmlldy5rZXlbcGtleUluZGV4XVtwYXJ0aXRpb25JbmRleF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICghb3V0cHV0TVZpZXcuc2VsZWN0LmluY2x1ZGVzKG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdKSkge1xuICAgICAgICAgIG91dHB1dE1WaWV3LnNlbGVjdC5wdXNoKG91dHB1dE1WaWV3LmtleVtwa2V5SW5kZXhdKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBjaGVjayBpZiBzZWxlY3QgaGFzICogYW5kIHRoZW4gYWRkIGFsbCBmaWVsZHMgdG8gc2VsZWN0XG4gICAgICBpZiAob3V0cHV0TVZpZXcuc2VsZWN0WzBdID09PSAnKicpIHtcbiAgICAgICAgb3V0cHV0TVZpZXcuc2VsZWN0ID0gT2JqZWN0LmtleXMob3V0cHV0U2NoZW1hLmZpZWxkcyk7XG4gICAgICB9XG5cbiAgICAgIG91dHB1dE1WaWV3LnNlbGVjdC5zb3J0KGFycmF5U29ydCk7XG5cbiAgICAgIGlmICghb3V0cHV0TVZpZXcud2hlcmVfY2xhdXNlKSB7XG4gICAgICAgIG91dHB1dE1WaWV3LndoZXJlX2NsYXVzZSA9IHBhcnNlci5nZXRfbXZpZXdfd2hlcmVfY2xhdXNlKG91dHB1dFNjaGVtYSwgb3V0cHV0TVZpZXcpO1xuICAgICAgfVxuICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChvdXRwdXRNVmlldy5maWx0ZXJzKSkge1xuICAgICAgICBkZWxldGUgb3V0cHV0TVZpZXcuZmlsdGVycztcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcblxuICBub3JtYWxpemVfaW5kZXhlcyhvdXRwdXRTY2hlbWEpIHtcbiAgICBpZiAoIW91dHB1dFNjaGVtYS5pbmRleGVzKSB7XG4gICAgICBvdXRwdXRTY2hlbWEuaW5kZXhlcyA9IFtdO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG91dHB1dFNjaGVtYS5pbmRleGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpbmRleE5hbWVMaXN0ID0gb3V0cHV0U2NoZW1hLmluZGV4ZXNbaV0ucmVwbGFjZSgvW1wiXFxzXS9nLCAnJykuc3BsaXQoL1soKV0vZyk7XG4gICAgICBpZiAoaW5kZXhOYW1lTGlzdC5sZW5ndGggPiAxKSB7XG4gICAgICAgIGluZGV4TmFtZUxpc3RbMF0gPSBpbmRleE5hbWVMaXN0WzBdLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmIChpbmRleE5hbWVMaXN0WzBdID09PSAndmFsdWVzJykgb3V0cHV0U2NoZW1hLmluZGV4ZXNbaV0gPSBpbmRleE5hbWVMaXN0WzFdO1xuICAgICAgICBlbHNlIG91dHB1dFNjaGVtYS5pbmRleGVzW2ldID0gdXRpbC5mb3JtYXQoJyVzKCVzKScsIGluZGV4TmFtZUxpc3RbMF0sIGluZGV4TmFtZUxpc3RbMV0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0cHV0U2NoZW1hLmluZGV4ZXNbaV0gPSBpbmRleE5hbWVMaXN0WzBdO1xuICAgICAgfVxuICAgIH1cbiAgICBvdXRwdXRTY2hlbWEuaW5kZXhlcy5zb3J0KGFycmF5U29ydCk7XG4gIH0sXG5cbiAgbm9ybWFsaXplX2N1c3RvbV9pbmRleGVzKG91dHB1dFNjaGVtYSkge1xuICAgIGlmIChvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4KSB7XG4gICAgICBvdXRwdXRTY2hlbWEuY3VzdG9tX2luZGV4ZXMgPSBbb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleF07XG4gICAgICBkZWxldGUgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleDtcbiAgICB9XG5cbiAgICBpZiAob3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzKSB7XG4gICAgICBjb25zdCBjdXN0b21BcnJheVNvcnQgPSAoYSwgYikgPT4ge1xuICAgICAgICBpZiAoYS5vbiA+IGIub24pIHJldHVybiAxO1xuICAgICAgICBpZiAoYS5vbiA8IGIub24pIHJldHVybiAtMTtcblxuICAgICAgICBpZiAoYS51c2luZyA+IGIudXNpbmcpIHJldHVybiAxO1xuICAgICAgICBpZiAoYS51c2luZyA8IGIudXNpbmcpIHJldHVybiAtMTtcblxuICAgICAgICBpZiAoYS5vcHRpb25zID4gYi5vcHRpb25zKSByZXR1cm4gMTtcbiAgICAgICAgaWYgKGEub3B0aW9ucyA8IGIub3B0aW9ucykgcmV0dXJuIC0xO1xuXG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfTtcblxuICAgICAgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzLnNvcnQoY3VzdG9tQXJyYXlTb3J0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzID0gW107XG4gICAgfVxuXG4gICAgb3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzID0gXy5yZW1vdmUob3V0cHV0U2NoZW1hLmN1c3RvbV9pbmRleGVzLCAoY2luZGV4KSA9PiAoY2luZGV4Lm9uICE9PSAnc29scl9xdWVyeScpKTtcbiAgfSxcblxuICBub3JtYWxpemVfbW9kZWxfc2NoZW1hKG1vZGVsU2NoZW1hKSB7XG4gICAgY29uc3Qgb3V0cHV0U2NoZW1hID0gXy5jbG9uZURlZXAobW9kZWxTY2hlbWEsIHRydWUpO1xuICAgIGNvbnN0IG5vcm1hbGl6YWJsZVNjaGVtYVByb3BlcnRpZXMgPSBbXG4gICAgICAnZmllbGRzJywgJ2tleScsICdjbHVzdGVyaW5nX29yZGVyJywgJ21hdGVyaWFsaXplZF92aWV3cycsICdpbmRleGVzJywgJ2N1c3RvbV9pbmRleCcsICdjdXN0b21faW5kZXhlcycsXG4gICAgXTtcblxuICAgIE9iamVjdC5rZXlzKG91dHB1dFNjaGVtYSkuZm9yRWFjaCgoc2NoZW1hUHJvcGVydHkpID0+IHtcbiAgICAgIGlmICghbm9ybWFsaXphYmxlU2NoZW1hUHJvcGVydGllcy5pbmNsdWRlcyhzY2hlbWFQcm9wZXJ0eSkpIHtcbiAgICAgICAgZGVsZXRlIG91dHB1dFNjaGVtYVtzY2hlbWFQcm9wZXJ0eV07XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLm5vcm1hbGl6ZV9maWVsZHMobW9kZWxTY2hlbWEsIG91dHB1dFNjaGVtYSk7XG4gICAgdGhpcy5ub3JtYWxpemVfcHJpbWFyeV9rZXkob3V0cHV0U2NoZW1hKTtcbiAgICB0aGlzLm5vcm1hbGl6ZV9tYXRlcmlhbGl6ZWRfdmlld3Mob3V0cHV0U2NoZW1hKTtcbiAgICB0aGlzLm5vcm1hbGl6ZV9pbmRleGVzKG91dHB1dFNjaGVtYSk7XG4gICAgdGhpcy5ub3JtYWxpemVfY3VzdG9tX2luZGV4ZXMob3V0cHV0U2NoZW1hKTtcblxuICAgIHJldHVybiBvdXRwdXRTY2hlbWE7XG4gIH0sXG5cbiAgcmVtb3ZlX2RlcGVuZGVudF92aWV3c19mcm9tX25vcm1hbGl6ZWRfc2NoZW1hKG5vcm1hbGl6ZWREQlNjaGVtYSwgZGJTY2hlbWEsIGZpZWxkTmFtZSkge1xuICAgIGNvbnN0IGRlcGVuZGVudFZpZXdzID0gW107XG4gICAgT2JqZWN0LmtleXMobm9ybWFsaXplZERCU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3cykuZm9yRWFjaCgoZGJWaWV3TmFtZSkgPT4ge1xuICAgICAgaWYgKG5vcm1hbGl6ZWREQlNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbZGJWaWV3TmFtZV0uc2VsZWN0LmluY2x1ZGVzKGZpZWxkTmFtZSkpIHtcbiAgICAgICAgZGVwZW5kZW50Vmlld3MucHVzaChkYlZpZXdOYW1lKTtcbiAgICAgIH0gZWxzZSBpZiAobm9ybWFsaXplZERCU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3c1tkYlZpZXdOYW1lXS5zZWxlY3RbMF0gPT09ICcqJykge1xuICAgICAgICBkZXBlbmRlbnRWaWV3cy5wdXNoKGRiVmlld05hbWUpO1xuICAgICAgfSBlbHNlIGlmIChub3JtYWxpemVkREJTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzW2RiVmlld05hbWVdLmtleS5pbmNsdWRlcyhmaWVsZE5hbWUpKSB7XG4gICAgICAgIGRlcGVuZGVudFZpZXdzLnB1c2goZGJWaWV3TmFtZSk7XG4gICAgICB9IGVsc2UgaWYgKF8uaXNBcnJheShub3JtYWxpemVkREJTY2hlbWEubWF0ZXJpYWxpemVkX3ZpZXdzW2RiVmlld05hbWVdLmtleVswXSlcbiAgICAgICAgICAgICAgICAgICYmIG5vcm1hbGl6ZWREQlNjaGVtYS5tYXRlcmlhbGl6ZWRfdmlld3NbZGJWaWV3TmFtZV0ua2V5WzBdLmluY2x1ZGVzKGZpZWxkTmFtZSkpIHtcbiAgICAgICAgZGVwZW5kZW50Vmlld3MucHVzaChkYlZpZXdOYW1lKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBkZXBlbmRlbnRWaWV3cy5mb3JFYWNoKCh2aWV3TmFtZSkgPT4ge1xuICAgICAgbm9ybWFsaXplZERCU2NoZW1hLm1hdGVyaWFsaXplZF92aWV3c1t2aWV3TmFtZV0gPSB7fTtcbiAgICB9KTtcbiAgfSxcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gbm9ybWFsaXplcjtcbiJdfQ==